{% extends 'konnekt/main.html' %}
{% load static %}
{% load time_filters %}
{% block main %}


<style type="text/css">
  .image-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    width: 100%;
  }

  /* One image */
  .image-grid.single .thumb-wrapper {
    flex: 0 0 auto;
    max-width: 100%;
  }

  /* Two images */
  .image-grid.two .thumb-wrapper {
    flex: 1 0 calc(50% - 8px);
    max-width: calc(50% - 8px);
  }

  /* Three or more */
  .image-grid.multi .thumb-wrapper {
    flex: 1 0 calc(33.333% - 8px);
    max-width: calc(33.333% - 8px);
  }

  .chat-thumbnail {
  width: 100px;
  height: 100px;
  border-radius: 6px;
  object-fit: cover;
}


</style>

<!-- <style>
  
  .image-grid {
  display: block;
}

.thumb-wrapper {
  display: inline-block;
  margin: 4px;
}

</style> -->
  <div id="layout" class="theme-cyan">

    {% include 'konnekt/nav_sidebar.html' %}
    {% include 'konnekt/rightbar.html' %}

    <div class="main px-xl-5 px-lg-4 px-3">
      <div class="chat-body">
        <div class="chat-header border-bottom py-xl-4 py-md-3 py-2">
          {% if messages %}
          {% for message in messages %}
          <div class="alert alert-info alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endfor %}
          {% endif %}
          <div class="container-xxl">
            <div class="row align-items-center">

              <div class="col-6 col-xl-4">
                <div class="media">
                  <div class="me-3 show-user-detail">
                    <span class="status rounded-circle"></span>
                    <img class="avatar rounded-circle" src="{{ sender.profile.avatar.url }}" alt="avatar" style="object-fit: cover;">
                  </div>
                  <div class="media-body overflow-hidden">
                    <div class="d-flex align-items-center mb-1">
                      <h6 class="text-truncate mb-0 me-auto" id="status-{{ sender.id }}" data-contact-id="{{ sender.id }}">
                        {% if sender.status.is_online %}
                        ðŸŸ¢ Online
                        {% elif sender.status.last_seen and not sender.status.is_online%}
                          âšª {{ sender.status.last_seen|natural_time_format }}
                        {% else %}
                          âšª Never
                        {% endif %}
                      </h6>
                    </div>
                    <div class="text-truncate">{{ sender.username }}</div>
                  </div>
                </div>
              </div>

              <div class="col-6 col-xl-8 text-end">
                <ul class="nav justify-content-end">
                  <li class="nav-item list-inline-item d-none d-md-block me-3">
                    <a href="#" class="nav-link text-muted px-3" data-toggle="collapse" data-target="#chat-search-div" aria-expanded="true" title="Search this chat">
                      <i class="zmdi zmdi-search zmdi-hc-lg"></i>
                    </a>
                  </li>
                  {% if sender.profile.phone %}
                  <li class="nav-item list-inline-item d-none d-sm-block me-3">
                    <a href="tel:{{ sender.profile.phone }}" class="nav-link text-muted px-3" title="Call">
                      <i class="zmdi zmdi-phone-forwarded zmdi-hc-lg"></i>
                    </a>
                  </li>
                  {% endif %}
                  {% if convo.is_group %}
                  <li class="nav-item list-inline-item add-user-btn">
                    <a href="#" class="nav-link text-muted px-3" title="Add Members">
                      <i class="zmdi zmdi-account-add zmdi-hc-lg"></i>
                    </a>
                  </li>
                  {% endif %}
                  <li class="nav-item list-inline-item add-user-btn">
                    <a href="#" class="nav-link text-muted px-3" title="Delete Conversation">
                      <i class="zmdi zmdi-delete zmdi-hc-lg"></i>
                    </a>
                  </li>
                  <li class="nav-item list-inline-item d-block d-sm-none px-3">
                    <div class="dropdown">
                      <a class="nav-link text-muted px-0" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="zmdi zmdi-more-vert zmdi-hc-lg"></i>
                      </a>
                      <div class="dropdown-menu dropdown-menu-right">
                        <a class="dropdown-item" href="#">Search chat</a>
                        {% if not contact %}
                        <form method="post" action="{% url 'chats' %}">
                          {% csrf_token %}
                          <input type="hidden" name="source" value="new_contact">
                          <input type="hidden" name="userID" value="{{ sender.id }}">
                          <button class="dropdown-item" type="submit">Add to Contacts</button>
                        </form>
                        {% endif %}
                        {% if sender.profile.phone %}
                        <a class="dropdown-item" href="tel:{{ sender.profile.phone }}">Call</a>
                        {% endif %}
                        {% if convo.is_group %}
                        <a class="dropdown-item" href="#">Add Members</a>
                        {% endif %}
                        <a class="dropdown-item" href="#">Delete Conversation</a>
                        <button class="dropdown-item" id="enable-notifications">Notif</button>
                      </div>
                    </div>
                  </li>

                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="collapse" id="chat-search-div">
          <div class="container-xxl py-2">
            <div class="input-group">
              <input type="text" class="form-control" placeholder="Find messages in current conversation">
              <div class="input-group-append">
                <span class="input-group-text text-muted">0 / 1</span>
              </div>
              <div class="input-group-append">
                <button type="button" class="btn btn-secondary">Search</button>
                <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <span class="sr-only">Toggle Dropdown</span>
                </button>
                <div class="dropdown-menu dropdown-menu-right shadow border-0">
                  <a class="dropdown-item" href="#">Action</a>
                  <a class="dropdown-item" href="#">Another action</a>
                  <a class="dropdown-item" href="#">Something else here</a>
                  <div role="separator" class="dropdown-divider"></div>
                  <a class="dropdown-item" href="#">Separated link</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="chat-content" id="chatBox">
          <div class="container-xxl">
            <ul class="list-unstyled py-4" id="chatItem">
        			{% with previous_date=None %}
        			{% for t in texts %}
              {% ifchanged t.timestamp.date %}
                <li class="d-flex message divider mt-xl-5 mt-md-3 mb-xl-5 mb-md-3">
                  <small class="text-muted">{{ t.timestamp|date:"l" }}</small>
                </li>
              {% endifchanged %}
      				{% if t.sender == request.user %}
      				<li class="d-flex message right user-message">
      					<div class="message-body">
      					<span class="date-time text-muted">{{ t.timestamp|natural_time_format }}
                  {% for r in r_statuses %}
                  {% if r.user != request.user and r.last_read_at > t.timestamp %}
                  <i class="zmdi zmdi-check-all text-primary read-mark"></i>
                  {% endif %}
                  {% endfor %}
                </span>
      					<div class="message-row d-flex align-items-center justify-content-end">
      						<div class="dropdown">
      						<a class="text-muted me-1 p-2 text-muted" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      							<i class="zmdi zmdi-more-vert"></i>
      						</a>
      						<div class="dropdown-menu">
      							<a class="dropdown-item" href="#">Edit</a>
      							<a class="dropdown-item" href="#">Share</a>
      							<a class="dropdown-item" href="#">Delete</a>
      						</div>
      						</div>
      						<div class="message-content border p-3">
                    <div>{{ t.body }}</div>
                    {% if t.attachment %}
                      <div class="mt-2">
                        <a href="{{ t.attachment.url }}" target="_blank" class="text-primary">
                          {{ t.attachment.name|cut:"media/" }}
                        </a>
                      </div>
                    {% endif %}
        
                    {% if t.images.all %}
                    <div class="image-grid mt-2">
                      {% for img in t.images.all %}
                        <a href="{{ img.image.url }}" class="thumb-wrapper glightbox">
                          <img src="{{ img.image.url }}" class="img-thumbnail chat-thumbnail" alt="sent image" data-gallery="{{ img.msgID }}">
                        </a>
                      {% endfor %}
                    </div>
                    {% endif %}
                  </div>
      					</div>
      					</div>
      				</li>
      				{% else %}
      				<li class="d-flex message">
      					<div class="mr-lg-3 me-2">
      					<img class="avatar sm rounded-circle" src="{{ t.sender.profile.avatar.url }}" alt="avatar" style="object-fit: cover;">
      					</div>
      					<div class="message-body">
      					<span class="date-time text-muted">{{ t.sender.username }}, {{ t.timestamp|natural_time_format }}</span>
      					<div class="message-row d-flex align-items-center">
      						<div class="message-content p-3">
                    <div>{{ t.body }}</div>

                    {% if t.attachment %}
                      <div class="mt-2">
                        <a href="{{ t.attachment.url }}" target="_blank" class="text-primary">
                          {{ t.attachment.name|cut:"media/" }}
                        </a>
                      </div>
                    {% endif %}

                    {% if t.images.all %}
                    <div class="image-grid mt-2">
                      {% for img in t.images.all %}

                        <a href="{{ img.image.url }}" class="thumb-wrapper glightbox" data-gallery="{{ img.msgID }}">
                          <img src="{{ img.image.url }}" class="img-thumbnail chat-thumbnail" alt="sent image">
                        </a>
                      {% endfor %}
                    </div>
                    {% endif %}

                  </div>
      						<div class="dropdown">
      						<a class="text-muted ms-1 p-2 text-muted" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      							<i class="zmdi zmdi-more-vert"></i>
      						</a>
      						<div class="dropdown-menu dropdown-menu-right">
      							<a class="dropdown-item" href="#">Edit</a>
      							<a class="dropdown-item" href="#">Share</a>
      							<a class="dropdown-item" href="#">Delete</a>
      						</div>
      						</div>
      					</div>
      					</div>

      				</li>
      				{% endif %}

      				{% comment %} Set the current message's date as previous_date for comparison in the next iteration {% endcomment %}
      				{% with previous_date=t.timestamp|date:"Y-m-d" %}
      				{% endwith %}
      			{% endfor %}
      			{% endwith %}

            </ul>
          </div>
        </div>

        <div class="chat-footer border-top py-xl-4 py-lg-2 py-2">
          <div class="container-xxl">
            <div class="row">
              <div class="col-12">
        				<form method="post" enctype="multipart/form-data" id="msgForm">
                  <!--<div id="attachmentPreview" class="mb-2 d-flex flex-wrap gap-2">hello africa</div>-->
                  {% csrf_token %}
                  <div id="filePreview" class="d-flex flex-wrap mt-2"></div>
        					<div class="input-group align-items-center">
        					<input type="text" class="form-control border-0 pl-0" id="msgBox" placeholder="Type your message...">
        					<div class="input-group-append d-none d-sm-block">
        						<span class="input-group-text border-0">
        						<button class="btn btn-sm btn-link text-muted" data-toggle="tooltip" title="Refresh" type="button"><i class="zmdi zmdi-refresh font-22"></i></button>
        						</span>
        					</div>
        					<div class="input-group-append">
        						<span class="input-group-text border-0">
        						<button id="emojiButton" class="btn btn-sm btn-link text-muted" type="button" title="Emoji Picker">
                      <i class="zmdi zmdi-mood font-22"></i>
                    </button>
        						</span>
        					</div>
        					<div class="input-group-append">
        						<span class="input-group-text border-0">
        						<label class="btn btn-sm btn-link text-muted" data-toggle="tooltip" title="Attachment" type="button">
                      <i class="zmdi zmdi-attachment font-22"></i>
                      <input type="file" name="attachments" id="attachmentInput" multiple style="display: none;" accept="image/*,application/pdf">
                    </label>
        						</span>
        					</div>

        					<div class="input-group-append">
        						<span class="input-group-text border-0 pr-0">
        						<button type="submit" class="btn btn-primary" id="sendBtn">
        							<span class="d-none d-md-inline-block me-2">Send</span>
        							<i class="zmdi zmdi-mail-send"></i>
        						</button>
        						</span>
        					</div>
        					</div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="user-detail-sidebar py-xl-4 py-3 px-xl-4 px-3">
        <div class="d-flex flex-column">
          <div class="header border-bottom pb-4 d-flex justify-content-between">
            <div>
              <h6 class="mb-0 font-weight-bold">User Details</h6>
            </div>
            <div>
              <button class="btn btn-link text-muted close-chat-sidebar" type="button"><i class="zmdi zmdi-close"></i></button>
            </div>
          </div>
          <div class="body mt-4">
            <div class="d-flex justify-content-center">
              <div class="avatar xxl">
                <img class="avatar xxl rounded-circle" src="{{ sender.profile.avatar.url }}" alt="avatar" style="object-fit: cover;">
              </div>
            </div>
            <div class="text-center mt-3 mb-5">
              <h4>Username: #{{ sender.username }}</h4>
              {% if sender.profile.fullname %}
              <p>Full Name: {{ sender.profile.fullname|title }}</p>
              {% endif %}
              <span class="text-muted"><a href="#">Email: {{ sender.email }}</a></span>
              <p><a href="{% url 'user_profile' sender.profile.identifier %}"><small>View Profile</small></a></p>
            </div>

            <ul class="chat-list">
              <li class="header d-flex justify-content-between ps-3 pe-3 mb-1">
                <span>mutual friend</span>
              </li>
              <li>
                <a href="#" class="card">
                  <div class="card-body">
                    <div class="media">
                      <div class="avatar me-3">
                        <img class="avatar rounded-circle" src="../assets/img/avatar2.png" alt="avatar">
                      </div>
                      <div class="media-body overflow-hidden">
                        <div class="d-flex align-items-center mb-1">
                          <h6 class="text-truncate mb-0 me-auto">Avatar 2</h6>
                        </div>
                        <div class="text-truncate">+6285xxxxxx</div>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              <li>
                <a href="#" class="card">
                  <div class="card-body">
                    <div class="media">
                      <div class="avatar me-3">
                        <img class="avatar rounded-circle" src="../assets/img/avatar4.png" alt="avatar">
                      </div>
                      <div class="media-body overflow-hidden">
                        <div class="d-flex align-items-center mb-1">
                          <h6 class="text-truncate mb-0 me-auto">Avatar 3</h6>
                        </div>
                        <div class="text-truncate">+6285xxxxxx</div>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              <li>
                <a href="#" class="card">
                  <div class="card-body">
                    <div class="media">
                      <div class="avatar me-3">
                        <img class="avatar rounded-circle" src="../assets/img/avatar1.jpg" alt="avatar">
                      </div>
                      <div class="media-body overflow-hidden">
                        <div class="d-flex align-items-center mb-1">
                          <h6 class="text-truncate mb-0 me-auto">Avatar 5</h6>
                        </div>
                        <div class="text-truncate">+6285xxxxxx</div>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="addnew-user-sidebar py-xl-4 py-3 px-xl-4 px-3">
        <div class="d-flex flex-column">
          <div class="header border-bottom pb-4 d-flex justify-content-between">
            <div>
              <h6 class="mb-0 font-weight-bold">Add new member</h6>
            </div>
            <div>
              <button class="btn btn-link text-muted close-chat-sidebar" type="button"><i class="zmdi zmdi-close"></i></button>
            </div>
          </div>
          <div class="body mt-4">

            <div class="form-group input-group-lg search mb-3">
              <i class="zmdi zmdi-search"></i>
              <input type="text" class="form-control" placeholder="Search...">
            </div>

            <ul class="chat-list">
              <li class="header d-flex justify-content-between ps-3 pe-3 mb-1">
                <span>A</span>
                <div class="dropdown">
                  <a class="btn btn-link px-1 py-0 border-0 text-muted dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></a>
                  <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="#">Action</a>
                    <a class="dropdown-item" href="#">Another action</a>
                    <a class="dropdown-item" href="#">Something else here</a>
                  </div>
                </div>
              </li>
              <li>
                <div class="hover_action">
                  <button type="button" class="btn btn-link text-info"><i class="zmdi zmdi-plus-circle"></i></button>
                </div>
                <a href="#" class="card">
                  <div class="card-body">
                    <div class="media">
                      <div class="avatar me-3">
                        <img class="avatar rounded-circle" src="../assets/img/avatar1.jpg" alt="avatar">
                      </div>
                      <div class="media-body overflow-hidden">
                        <div class="d-flex align-items-center mb-1">
                          <h6 class="text-truncate mb-0 me-auto">Avatar 1</h6>
                        </div>
                        <div class="text-truncate">
                          last seen 1 day ago
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              <li>
                <div class="hover_action">
                  <button type="button" class="btn btn-link text-info"><i class="zmdi zmdi-plus-circle"></i></button>
                </div>
                <a href="#" class="card">
                  <div class="card-body">
                    <div class="media">
                      <div class="avatar me-3">
                        <img class="avatar rounded-circle" src="../assets/img/avatar2.png" alt="avatar">
                      </div>
                      <div class="media-body overflow-hidden">
                        <div class="d-flex align-items-center mb-1">
                          <h6 class="text-truncate mb-0 me-auto">Avatar 2</h6>
                        </div>
                        <div class="text-truncate">
                          last seen 1 day ago
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              <li>
                <div class="hover_action">
                  <button type="button" class="btn btn-link text-info"><i class="zmdi zmdi-plus-circle"></i></button>
                </div>
                <a href="#" class="card">
                  <div class="card-body">
                    <div class="media">
                      <div class="avatar me-3">
                        <img class="avatar rounded-circle" src="../assets/img/avatar3.png" alt="avatar">
                      </div>
                      <div class="media-body overflow-hidden">
                        <div class="d-flex align-items-center mb-1">
                          <h6 class="text-truncate mb-0 me-auto">Avatar 3</h6>
                        </div>
                        <div class="text-truncate">
                          last seen 1 day ago
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              <li>
                <div class="hover_action">
                  <button type="button" class="btn btn-link text-info"><i class="zmdi zmdi-plus-circle"></i></button>
                </div>
                <a href="#" class="card">
                  <div class="card-body">
                    <div class="media">
                      <div class="avatar me-3">
                        <img class="avatar rounded-circle" src="../assets/img/avatar4.png" alt="avatar">
                      </div>
                      <div class="media-body overflow-hidden">
                        <div class="d-flex align-items-center mb-1">
                          <h6 class="text-truncate mb-0 me-auto">Avatar 4</h6>
                        </div>
                        <div class="text-truncate">
                          last seen 1 day ago
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              <li>
                <div class="hover_action">
                  <button type="button" class="btn btn-link text-info"><i class="zmdi zmdi-plus-circle"></i></button>
                </div>
                <a href="#" class="card">
                  <div class="card-body">
                    <div class="media">
                      <div class="avatar me-3">
                        <img class="avatar rounded-circle" src="../assets/img/avatar5.png" alt="avatar">
                      </div>
                      <div class="media-body overflow-hidden">
                        <div class="d-flex align-items-center mb-1">
                          <h6 class="text-truncate mb-0 me-auto">Avatar 5</h6>
                        </div>
                        <div class="text-truncate">
                          last seen 1 day ago
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              <li class="header d-flex justify-content-between ps-3 pe-3 mb-1">
                <span>D</span>
              </li>
              <li>
                <div class="hover_action">
                  <button type="button" class="btn btn-link text-info"><i class="zmdi zmdi-plus-circle"></i></button>
                </div>
                <a href="#" class="card">
                  <div class="card-body">
                    <div class="media">
                      <div class="avatar me-3">
                        <img class="avatar rounded-circle" src="../assets/img/avatar6.png" alt="avatar">
                      </div>
                      <div class="media-body overflow-hidden">
                        <div class="d-flex align-items-center mb-1">
                          <h6 class="text-truncate mb-0 me-auto">Avatar 6</h6>
                        </div>
                        <div class="text-truncate">
                          last seen 1 day ago
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              <li class="header d-flex justify-content-between ps-3 pe-3 mb-1">
                <span>M</span>
              </li>
              <li>
                <div class="hover_action">
                  <button type="button" class="btn btn-link text-info"><i class="zmdi zmdi-plus-circle"></i></button>
                </div>
                <a href="#" class="card">
                  <div class="card-body">
                    <div class="media">
                      <div class="avatar me-3">
                        <img class="avatar rounded-circle" src="../assets/img/avatar2.png" alt="avatar">
                      </div>
                      <div class="media-body overflow-hidden">
                        <div class="d-flex align-items-center mb-1">
                          <h6 class="text-truncate mb-0 me-auto">Avatar 7</h6>
                        </div>
                        <div class="text-truncate">
                          last seen 1 day ago
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              <li>
                <div class="hover_action">
                  <button type="button" class="btn btn-link text-info"><i class="zmdi zmdi-plus-circle"></i></button>
                </div>
                <a href="#" class="card">
                  <div class="card-body">
                    <div class="media">
                      <div class="avatar me-3">
                        <img class="avatar rounded-circle" src="../assets/img/avatar3.png" alt="avatar">
                      </div>
                      <div class="media-body overflow-hidden">
                        <div class="d-flex align-items-center mb-1">
                          <h6 class="text-truncate mb-0 me-auto">Avatar 8</h6>
                        </div>
                        <div class="text-truncate">
                          last seen 1 day ago
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
              <li class="header d-flex justify-content-between ps-3 pe-3 mb-1">
                <span>T</span>
              </li>
              <li>
                <div class="hover_action">
                  <button type="button" class="btn btn-link text-info"><i class="zmdi zmdi-plus-circle"></i></button>
                </div>
                <a href="#" class="card">
                  <div class="card-body">
                    <div class="media">
                      <div class="avatar me-3">
                        <img class="avatar rounded-circle" src="../assets/img/avatar4.png" alt="avatar">
                      </div>
                      <div class="media-body overflow-hidden">
                        <div class="d-flex align-items-center mb-1">
                          <h6 class="text-truncate mb-0 me-auto">Avatar 9</h6>
                        </div>
                        <div class="text-truncate">
                          last seen 1 day ago
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

 <script type="text/javascript">

  const chatSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/konnekt/{{ convo_id }}/"
  );

const fileStore = new DataTransfer();

const msgForm = document.getElementById("msgForm");
const msgBox = document.getElementById("msgBox");
const sendBtn = document.getElementById("sendBtn");
const chatItem = document.getElementById("chatBox");

const currentUserId = "{{ request.user.id }}";
const senderAvatar = "{{ sender.profile.avatar.url }}";
const convoID = "{{ convo_id }}"


function formatTime(ts) {
  const date = new Date(ts);
  const now = new Date();
  const delta = (now - date) / 1000;

  if (delta < 60) return "Just now";
  if (delta < 3600) return Math.floor(delta / 60) + " min ago";
  if (delta < 86400) return Math.floor(delta / 3600) + " hr ago";
  if (delta < 172800) return "Yesterday";
  return date.toLocaleDateString();
}

function scrollToBottom() {
  chatItem.scrollTop = chatItem.scrollHeight;
}

function isNearBottom() {
  const threshold = 3 * window.innerHeight;
  return chatItem.scrollHeight - chatItem.scrollTop <= chatItem.clientHeight + threshold;
}

function sendReadReceipt(convID, userID) {
  if (chatSocket.readyState !== WebSocket.OPEN) return;

  data = {
    type: "read_status.send",
    convo_id: convID,
    user_id: userID,
    timestamp: Date.now(),
  }

  chatSocket.send(
    JSON.stringify(data)
  );
}


chatItem.addEventListener("scroll", () => {
  const nearBottom = chatItem.scrollHeight - chatItem.scrollTop <= chatItem.clientHeight + 10;
  if (nearBottom) sendReadReceipt(convoID, currentUserId);
});


window.addEventListener("load", () => {
  setTimeout(() => {
    scrollToBottom();
  }, 100);
});



chatSocket.addEventListener("message", (event) => {
  const data = JSON.parse(event.data);
  const sender = data["sender"];
  const message = data["message"];
  const sender_id = data["sender_id"];
  const timestamp = data["timestamp"];
  const s_time = formatTime(timestamp);
  const imageUrls = data["image_urls"] || [];
  const photoID = data["uniqueMsgID"]

  if (data.type === "chat_message") {
    // Append new message
    if (message || imageUrls.length > 0) {
      let messageHTML = "";
      let imageHTML = "";

      if (imageUrls && imageUrls.length > 0) {
        // let gridClass = 'multi';
        // if (imageUrls.length === 1) gridClass = 'single';  
        // if (imageUrls.length === 2) gridClass = 'two';

        imageHTML = `
          <div class="image-grid mt-2">
            ${imageUrls.map(url => `
              <a href="${url}" class="thumb-wrapper glightbox" data-gallery="${photoID}">
                <img src="${url}" class="img-thumbnail chat-thumbnail" alt="image">
              </a>
            `).join('')}
          </div>
        `;
      }

      if (sender_id == currentUserId) {
        document.getElementById("attachmentInput").value = "";
        msgBox.value = "";
        messageHTML = `
          <li class="d-flex message right user-message" data-timestamp="${timestamp}">
              <div class="message-body">
                  <span class="date-time text-muted">${s_time}
                      <i class="zmdi zmdi-check-all text-primary read-mark" style="display: none;"></i>
                  </span>
                  <div class="message-row d-flex align-items-center justify-content-end">
                      <div class="dropdown">
                          <a class="text-muted me-1 p-2" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                              <i class="zmdi zmdi-more-vert"></i>
                          </a>
                          <div class="dropdown-menu">
                              <a class="dropdown-item" href="#">Edit</a>
                              <a class="dropdown-item" href="#">Share</a>
                              <a class="dropdown-item" href="#">Delete</a>
                          </div>
                      </div>
                      <div class="message-content border p-3">${message}${imageHTML}</div>
                  </div>
              </div>
          </li>`;
      } else {
        messageHTML = `
          <li class="d-flex message">
              <div class="mr-lg-3 me-2">
                  <img class="avatar sm rounded-circle" src="${senderAvatar}" alt="avatar" style="object-fit: cover;">
              </div>
              <div class="message-body">
                  <span class="date-time text-muted">${sender}, ${s_time}</span>
                  <div class="message-row d-flex align-items-center">
                      <div class="message-content p-3">${message}${imageHTML}</div>
                      <div class="dropdown">
                          <a class="text-muted ms-1 p-2" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                              <i class="zmdi zmdi-more-vert"></i>
                          </a>
                          <div class="dropdown-menu dropdown-menu-right">
                              <a class="dropdown-item" href="#">Edit</a>
                              <a class="dropdown-item" href="#">Share</a>
                              <a class="dropdown-item" href="#">Delete</a>
                          </div>
                      </div>
                  </div>
              </div>
          </li>`;
      }

      chatItem.insertAdjacentHTML("beforeend", messageHTML);

      // Wait for all images to load before scrolling
      const newlyInserted = chatItem.querySelectorAll(`.message[data-timestamp="${timestamp}"] img`);

      if (newlyInserted.length > 0) {
        let loadedCount = 0;
        newlyInserted.forEach(img => {
          img.addEventListener('load', () => {
            loadedCount++;
            if (loadedCount === newlyInserted.length) {
              if (isNearBottom()) scrollToBottom();
            }
          });
          img.addEventListener('error', () => {
            loadedCount++;
            if (loadedCount === newlyInserted.length) {
              if (isNearBottom()) scrollToBottom();
            }
          });
        });
      } else {
        if (isNearBottom()) scrollToBottom(); // no images to wait for
      }

      // Clear file input and previews
      document.getElementById("attachmentInput").value = "";
      fileStore.items.clear(); // clear the stored files

      const previewContainer = document.getElementById("filePreview");
      if (previewContainer) {
        previewContainer.querySelectorAll("img").forEach(img => URL.revokeObjectURL(img.src));
        previewContainer.innerHTML = "";
      }

      // Re-initialize GLightbox after inserting new images
      if (window.lightboxInstance) {
        window.lightboxInstance.destroy();
      }
      window.lightboxInstance = GLightbox({
        selector: '.glightbox'
      });

    }
  }


  // Insert read receipts
  if (data.type === "read_status") {
    if (data.user_id != currentUserId) {
      const userMessages = [...document.querySelectorAll(".user-message")];
      if (userMessages.length > 0) {

        userMessages.forEach(msg => {
          const mark = msg.querySelector(".read-mark");
          if (mark) mark.style.display = "inline";
        });

      }
    }
  }


  // Handle the browser notification
  if (data.type === 'notification') {
    if (Notification.permission === "granted") {
      new Notification(data.title, { body: data.message });
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          new Notification(data.title, { body: data.message });
        }
      });
    }
  }

});


document.addEventListener("DOMContentLoaded", function() {
  const input = document.getElementById("attachmentInput");
  const preview = document.getElementById("filePreview");

  input.addEventListener("change", function() {
    [...input.files].forEach((file) => {
      fileStore.items.add(file);
    });

    input.files = fileStore.files;
    renderPreviews();
  });

  function renderPreviews() {
    preview.innerHTML = ""; // Clear DOM

    [...fileStore.files].forEach((file, index) => {
      const isImage = file.type.startsWith("image/");
      const wrapper = document.createElement("div");
      wrapper.className = "position-relative m-2";
      wrapper.style.width = "100px";
      wrapper.style.height = "100px";

      const closeBtn = document.createElement("button");
      closeBtn.type = "button";
      closeBtn.innerHTML = "&times;";
      closeBtn.className = "btn btn-sm btn-danger position-absolute top-0 end-0";
      closeBtn.onclick = () => {
        const newData = new DataTransfer();
        [...fileStore.files].forEach((f, i) => {
          if (i !== index) newData.items.add(f);
        });
        fileStore.items.clear();
        [...newData.files].forEach(f => fileStore.items.add(f));
        input.files = fileStore.files;
        renderPreviews();
      };

      if (isImage) {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.className = "img-thumbnail";
        img.style.width = "100%";
        img.style.height = "100%";
        img.style.objectFit = "cover";
        img.onload = () => URL.revokeObjectURL(img.src);
        wrapper.appendChild(img);
      } else {
        const icon = document.createElement("div");
        icon.className = "d-flex align-items-center justify-content-center border bg-light";
        icon.style.width = "100%";
        icon.style.height = "100%";
        icon.innerHTML = `<i class="zmdi zmdi-file-text font-22"></i>`;
        wrapper.appendChild(icon);
      }

      wrapper.appendChild(closeBtn);
      preview.appendChild(wrapper);
    });
  }
});


function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function generateUniqueId(length = 12) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  const cryptoObj = window.crypto || window.msCrypto;

  const randomValues = new Uint32Array(length);
  cryptoObj.getRandomValues(randomValues);

  for (let i = 0; i < length; i++) {
      result += chars[randomValues[i] % chars.length];
  }

  return result;
}

sendBtn.addEventListener("click", async (e) => {
  e.preventDefault();

  const message = msgBox.value.trim();
  const files = attachmentInput.files;

  if (!message && files.length === 0) return;

  const uploadedImages = [];
  const uniqueMsgID = generateUniqueId(10);
  let s_uniqueMsgID = '';


  // 1. Upload attachments
  if (files.length > 0) {
    for (const file of files) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('convo_id', convoID);
      formData.append('sender_id', currentUserId);
      formData.append('msgID', uniqueMsgID);

      try {
        const response = await fetch('/konnekt/upload_attachment/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken()
          },
          body: formData,
        });

        const data = await response.json();
        console.log('form response:', data);

        if (data.attachment_type === 'image') {
          uploadedImages.push(data.image_urls);
          s_uniqueMsgID = data.uniqueMsgID;
        }
      } catch (err) {
        console.error("File upload failed:", err);
      }
    }
  }


  // 2. Send a single WebSocket message with text and all images
  if (message || uploadedImages.length > 0) {
    chatSocket.send(JSON.stringify({
      message: message,
      image_urls: uploadedImages.flat(),
      sender_id: currentUserId,
      uniqueMsgID: s_uniqueMsgID,
      sender: '{{ request.user.username }}',
      convo_id: convoID,
      timestamp: Date.now()
    }));
  }

  // 3. Reset input
  msgBox.value = "";
  attachmentInput.value = "";
  filePreview.innerHTML = "";
  fileStore.items.clear();

});

msgBox.addEventListener("keypress", function(e) {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});


</script>
<script type="module">
  import {
    EmojiButton
  } from 'https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js';

  const button = document.getElementById('emojiButton');
  const input = document.getElementById('msgBox');

  // Initialize EmojiButton
  const picker = new EmojiButton({
    autoHide: false,
    position: 'top-end',
    zIndex: 9999
  });

  // Open emoji picker when the button is clicked
  button.addEventListener('click', () => {
    picker.togglePicker(button);
  });

  // Append the selected emoji to the input field
  picker.on('emoji', (emoji) => {
    input.value += emoji.emoji; // Add emoji to the message box
  });

</script>


<script type="module">
  import 'https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js';

  window.onload = () => {
    const lightbox = GLightbox({
      selector: '.glightbox',
    });
  };

</script>

<script type="text/javascript">

    // async function registerServiceWorker() {
    //     if ('serviceWorker' in navigator) {
    //         try {
    //             const registration = await navigator.serviceWorker.register('/static/konnekt/js/notifications_worker.js');
    //             return registration;
    //         } catch (error) {
    //             console.error('ServiceWorker registration failed:', error);
    //         }
    //     }
    //     return null;
    // }





    async function subscribeToPushNotifications(registration) {
        try {
            // 1. Get VAPID public key
            const response = await fetch('/konnekt/notifications/vapid-public-key/');
            if (!response.ok) throw new Error('Failed to get VAPID key');
            
            const pubKey = await response.json();
            if (!pubKey) throw new Error('Invalid VAPID key format');

            // 2. Convert VAPID key to Uint8Array
            const convertedVapidKey = urlBase64ToUint8Array(pubKey.vapidPublicKey);
            console.log(convertedVapidKey);

            // 3. Subscribe to push
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: convertedVapidKey
            });

            return subscription;
        } catch (error) {
            console.error('Push subscription error:', error);
            throw error;
        }
    }

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/-/g, '+')
            .replace(/_/g, '/');
        const rawData = window.atob(base64);
        return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
    }

    async function setupPushNotifications() {
      const registration = await navigator.serviceWorker.register('/static/konnekt/js/notifications_worker.js');
      console.log('Service worker registered');

      let subscription = await registration.pushManager.getSubscription();
      
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') {
          throw new Error('Permission not granted');
      }

      subscription = await subscribeToPushNotifications(registration);

      if (window.chatSocket) {
          window.chatSocket.send(JSON.stringify({
              type: 'push.subscribe',
              subscription: subscription.toJSON()
          }));
      }

      return subscription;
  
    }

    // Initialize when DOM loads
    document.addEventListener('DOMContentLoaded', setupPushNotifications);

</script>

{% endblock %}
